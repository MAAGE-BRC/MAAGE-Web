<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MAAGE - Demo Map</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;1,100;1,200;1,300;1,400;1,500;1,600;1,700&family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
        rel="stylesheet">
    <script src="https://kit.fontawesome.com/4bb90511c9.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/topojson-client@3"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/maage_client.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        heading: ['Poppins', 'sans-serif'],
                        poppins: ['Poppins', 'sans-serif'],
                        body: ['Inter', 'sans-serif'],
                        inter: ['Inter', 'sans-serif'],
                        mono: ['IBM Plex Mono', 'monospace'],
                        ibmplexmono: ['IBM Plex Mono', 'monospace'],
                    },
                    maxWidth: {
                        maage: '1400px',
                    },
                    colors: {
                        maage: {
                            primary: {
                                50: '#f3f7f5',
                                100: '#ecf3f0',
                                200: '#d6e5de',
                                300: '#b4d0c3',
                                400: '#98bdac',
                                500: '#6ea089',
                                600: '#57856f',
                                700: '#496f5d',
                                800: '#3c5d4e',
                                900: '#324d41',
                                950: '#1c2b24',
                            },
                            secondary: {
                                50: '#eef4f7',
                                100: '#dce9ef',
                                200: '#c1d8e1',
                                300: '#a0c1cf',
                                400: '#87afc0',
                                500: '#5f94ab',
                                600: '#467386',
                                700: '#406777',
                                800: '#365663',
                                900: '#2e4a56',
                                950: '#22363f',
                            },
                            tertiary: {
                                50: '#fdfaf2',
                                100: '#fbf6e9',
                                200: '#f8edd8',
                                300: '#f4e4c2',
                                400: '#edd5a6',
                                500: '#e7c788',
                                600: '#dab46c',
                                700: '#d29c4b',
                                800: '#bb8335',
                                900: '#946729',
                                950: '#6d461d',
                            },
                        },
                    },
                },
            },
        }
    </script>
    <style>
        .state, .county, .country {
            stroke: #d1d5db;
            stroke-width: 1px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .state:hover, .county:hover, .country:hover {
            stroke-width: 2.5px;
            stroke: #374151;
            filter: brightness(0.95);
        }
        
        .tooltip {
            position: absolute;
            text-align: left;
            padding: 10px;
            font: 12px Inter, sans-serif;
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid #ddd;
            border-radius: 6px;
            pointer-events: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            opacity: 0;
            transition: opacity 0.2s;
        }
    </style>
</head>

<body class="bg-gray-50">
    <div class="max-w-maage mx-auto p-6">
        <div class="bg-white rounded-xl shadow-lg p-8">
            <h1 class="text-3xl font-heading font-bold text-maage-primary-900 mb-6">
                MAAGE Interactive Map
            </h1>
            
            <!-- Controls -->
            <div class="flex flex-col gap-4 mb-6">
                <!-- Query Controls -->
                <div class="flex flex-wrap gap-4">
                    <div class="flex-1 max-w-md">
                        <label for="taxon-id-input" class="block text-sm font-medium text-gray-700 mb-1">
                            Taxon ID
                        </label>
                        <div class="flex gap-2">
                            <input 
                                type="text" 
                                id="taxon-id-input" 
                                placeholder="Enter taxon ID (e.g., 590 for Salmonella)"
                                class="flex-1 px-4 py-2 rounded-lg border border-gray-300 text-sm focus:outline-none focus:ring-2 focus:ring-maage-primary-500"
                            />
                            <button 
                                id="query-btn" 
                                class="px-6 py-2 bg-maage-primary-600 text-white rounded-lg text-sm font-medium hover:bg-maage-primary-700 transition-colors"
                            >
                                Query
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- View Controls -->
                <div class="flex flex-wrap gap-4">
                    <!-- View Toggle -->
                    <div class="flex bg-gray-100 rounded-lg p-1">
                        <button id="world-view-btn" class="px-4 py-2 rounded-md text-sm font-medium transition-colors">
                            World
                        </button>
                        <button id="usa-view-btn" class="px-4 py-2 rounded-md text-sm font-medium transition-colors">
                            United States
                        </button>
                        <button id="state-view-btn" class="px-4 py-2 rounded-md text-sm font-medium transition-colors">
                            States
                        </button>
                    </div>
                    
                    <!-- State Dropdown -->
                    <div id="state-selector" class="hidden">
                        <select id="state-dropdown" class="px-4 py-2 rounded-lg border border-gray-300 text-sm font-medium focus:outline-none focus:ring-2 focus:ring-maage-primary-500">
                            <option value="">Select a state...</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <!-- Map Container -->
            <div id="map-container" class="relative bg-gray-50 rounded-lg overflow-hidden" style="height: 600px;">
                <div id="map" class="w-full h-full"></div>
            </div>
            
            <!-- Legend -->
            <div class="mt-6">
                <h3 class="text-sm font-semibold text-gray-700 mb-2">Genome Count Density</h3>
                <div class="flex items-center gap-4 flex-wrap">
                    <div class="flex items-center gap-2">
                        <div class="w-4 h-4 rounded border border-gray-300" style="background-color: #f9fafb"></div>
                        <span class="text-xs text-gray-600">No data</span>
                    </div>
                    <div class="text-gray-400">|</div>
                    <div class="flex items-center gap-2">
                        <div class="w-4 h-4 rounded border border-gray-300" style="background-color: #e8f0ec"></div>
                        <span class="text-xs text-gray-600">Low</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-4 h-4 rounded border border-gray-300" style="background-color: #98bdac"></div>
                        <span class="text-xs text-gray-600">Medium</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-4 h-4 rounded border border-gray-300" style="background-color: #6ea089"></div>
                        <span class="text-xs text-gray-600">High</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-4 h-4 rounded border border-gray-300" style="background-color: #496f5d"></div>
                        <span class="text-xs text-gray-600">Highest</span>
                    </div>
                </div>
            </div>
            
            <!-- Details Panel -->
            <div id="details-panel" class="mt-6 hidden">
                <div class="border-t pt-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Query Details</h3>
                    
                    <!-- Taxon Name Header -->
                    <div class="mb-4">
                        <h2 id="taxon-name-header" class="text-2xl font-bold text-gray-900"></h2>
                    </div>
                    
                    <!-- Summary Statistics -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <div class="bg-maage-primary-50 rounded-lg p-4">
                            <div class="text-2xl font-bold text-maage-primary-800" id="total-genomes">0</div>
                            <div class="text-sm text-maage-primary-600" id="total-genomes-label">Total USA Genomes</div>
                        </div>
                        <div class="bg-maage-secondary-50 rounded-lg p-4">
                            <div class="text-2xl font-bold text-maage-secondary-800" id="states-with-data">0</div>
                            <div class="text-sm text-maage-secondary-600">States with Data</div>
                        </div>
                        <div class="bg-maage-tertiary-50 rounded-lg p-4">
                            <div class="text-2xl font-bold text-maage-tertiary-800" id="avg-per-state">0</div>
                            <div class="text-sm text-maage-tertiary-600">Average per State</div>
                        </div>
                    </div>
                    
                    <!-- Top States/Countries -->
                    <div class="mb-6">
                        <h4 class="text-sm font-semibold text-gray-700 mb-3" id="top-regions-title">Top 5 States by Genome Count</h4>
                        <div id="top-states" class="space-y-2"></div>
                    </div>
                    
                    <!-- Additional Metadata -->
                    <div id="metadata-section" class="mb-6">
                        <h4 class="text-sm font-semibold text-gray-700 mb-3">Collection Year Distribution</h4>
                        <div id="year-distribution" class="text-sm text-gray-600"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Tooltip -->
    <div class="tooltip"></div>

    <script>
        // State names mapping
        const stateNames = {
            "01": "Alabama", "02": "Alaska", "04": "Arizona", "05": "Arkansas", "06": "California",
            "08": "Colorado", "09": "Connecticut", "10": "Delaware", "11": "District of Columbia",
            "12": "Florida", "13": "Georgia", "15": "Hawaii", "16": "Idaho", "17": "Illinois",
            "18": "Indiana", "19": "Iowa", "20": "Kansas", "21": "Kentucky", "22": "Louisiana",
            "23": "Maine", "24": "Maryland", "25": "Massachusetts", "26": "Michigan", "27": "Minnesota",
            "28": "Mississippi", "29": "Missouri", "30": "Montana", "31": "Nebraska", "32": "Nevada",
            "33": "New Hampshire", "34": "New Jersey", "35": "New Mexico", "36": "New York",
            "37": "North Carolina", "38": "North Dakota", "39": "Ohio", "40": "Oklahoma", "41": "Oregon",
            "42": "Pennsylvania", "44": "Rhode Island", "45": "South Carolina", "46": "South Dakota",
            "47": "Tennessee", "48": "Texas", "49": "Utah", "50": "Vermont", "51": "Virginia",
            "53": "Washington", "54": "West Virginia", "55": "Wisconsin", "56": "Wyoming"
        };

        // Global variables
        let currentView = 'world';
        let selectedState = '17'; // Illinois by default
        let worldData = null;
        let usaData = null;
        let countiesData = null;
        let geoJsonCountiesData = null;
        let genomeData = null; // Store fetched genome data
        let maageClient = null; // MAAGE API client

        // Color scale - using a more visible light color for zero/low values
        const colorScale = d3.scaleQuantile()
            .domain([0, 100])
            .range(['#e8f0ec', '#b4d0c3', '#98bdac', '#6ea089', '#57856f', '#496f5d', '#324d41']);

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize MAAGE client
            maageClient = new MAAGEClient('https://www.maage-brc.org/api');
            
            setupEventListeners();
            populateStateDropdown();
            setActiveView('world');
            loadWorldData();
            loadUSAData();
        });

        // Setup event listeners
        function setupEventListeners() {
            document.getElementById('world-view-btn').addEventListener('click', () => {
                setActiveView('world');
            });
            
            document.getElementById('usa-view-btn').addEventListener('click', () => {
                setActiveView('usa');
            });
            
            document.getElementById('state-view-btn').addEventListener('click', () => {
                setActiveView('state');
            });
            
            document.getElementById('state-dropdown').addEventListener('change', (e) => {
                if (e.target.value) {
                    selectedState = e.target.value;
                    renderStateView();
                }
            });
            
            // Query button listener
            document.getElementById('query-btn').addEventListener('click', () => {
                const taxonId = document.getElementById('taxon-id-input').value.trim();
                if (taxonId) {
                    queryGenomeData(taxonId);
                }
            });
            
            // Enter key listener for taxon ID input
            document.getElementById('taxon-id-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    const taxonId = e.target.value.trim();
                    if (taxonId) {
                        queryGenomeData(taxonId);
                    }
                }
            });
        }

        // Populate state dropdown
        function populateStateDropdown() {
            const dropdown = document.getElementById('state-dropdown');
            Object.entries(stateNames).forEach(([fips, name]) => {
                const option = document.createElement('option');
                option.value = fips;
                option.textContent = name;
                if (fips === '17') option.selected = true;
                dropdown.appendChild(option);
            });
        }

        // Set active view
        function setActiveView(view) {
            currentView = view;
            
            // Update button styles
            const worldBtn = document.getElementById('world-view-btn');
            const usaBtn = document.getElementById('usa-view-btn');
            const stateBtn = document.getElementById('state-view-btn');
            const stateSelector = document.getElementById('state-selector');
            
            // Remove active styles from all buttons
            [worldBtn, usaBtn, stateBtn].forEach(btn => {
                btn.classList.remove('bg-white', 'text-maage-primary-700', 'shadow');
                btn.classList.add('text-gray-600');
            });
            
            if (view === 'world') {
                worldBtn.classList.add('bg-white', 'text-maage-primary-700', 'shadow');
                worldBtn.classList.remove('text-gray-600');
                stateSelector.classList.add('hidden');
                renderWorldView();
            } else if (view === 'usa') {
                usaBtn.classList.add('bg-white', 'text-maage-primary-700', 'shadow');
                usaBtn.classList.remove('text-gray-600');
                stateSelector.classList.add('hidden');
                renderUSAView();
            } else if (view === 'state') {
                stateBtn.classList.add('bg-white', 'text-maage-primary-700', 'shadow');
                stateBtn.classList.remove('text-gray-600');
                stateSelector.classList.remove('hidden');
                renderStateView();
            }
        }

        // Load world data
        async function loadWorldData() {
            try {
                // Use CDN-hosted world topology data
                const response = await fetch('https://cdn.jsdelivr.net/npm/world-atlas@2/countries-110m.json');
                const topology = await response.json();
                
                // Convert TopoJSON to GeoJSON
                worldData = topojson.feature(topology, topology.objects.countries);
                
                if (currentView === 'world') {
                    renderWorldView();
                }
            } catch (error) {
                console.error('Error loading world data:', error);
            }
        }
        
        // Load USA data
        async function loadUSAData() {
            try {
                const response = await fetch('/maps/usa-states-albers-10m.json');
                const topology = await response.json();
                usaData = topojson.feature(topology, topology.objects.states);
                if (currentView === 'usa') {
                    renderUSAView();
                }
            } catch (error) {
                console.error('Error loading USA data:', error);
            }
        }

        // Load counties data
        async function loadCountiesData() {
            if (countiesData) return;
            
            try {
                const response = await fetch('/maps/usa-counties-albers-10m.json');
                const topology = await response.json();
                countiesData = topojson.feature(topology, topology.objects.counties);
            } catch (error) {
                console.error('Error loading counties data:', error);
            }
        }
        
        // Load GeoJSON counties data
        async function loadGeoJsonCountiesData() {
            if (geoJsonCountiesData) return;
            
            try {
                const response = await fetch('/geojson/cb_2024_us_county_5m.geojson');
                geoJsonCountiesData = await response.json();
            } catch (error) {
                console.error('Error loading GeoJSON counties data:', error);
            }
        }

        // Generate mock data
        function generateMockData(features) {
            const data = new Map();
            features.forEach(feature => {
                const id = feature.id || feature.properties.name;
                data.set(id, {
                    value: Math.random() * 100,
                    samples: Math.floor(Math.random() * 1000),
                    variants: Math.floor(Math.random() * 50)
                });
            });
            return data;
        }
        
        // Query genome data from MAAGE API
        async function queryGenomeData(taxonId) {
            const queryBtn = document.getElementById('query-btn');
            
            try {
                // Update UI status
                queryBtn.disabled = true;
                queryBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Querying...';
                
                // First, fetch taxonomy information
                const taxonQuery = `eq(taxon_id,${taxonId})&limit(1)`;
                const taxonResult = await maageClient.query('taxonomy', taxonQuery, { accept: 'application/json' });
                console.log('Taxon result:', taxonResult);
                
                // Build the query for USA genomes with the specified taxon_id
                // Using facets to get state counts, and will query for county data separately
                const stateQuery = `and(eq(taxon_id,${taxonId}),eq(isolation_country,USA),facet((field,state_province),(mincount,1)))`;
                
                const stateOptions = {
                    accept: 'application/solr+json',
                    limit: 0  // We only need facet counts
                };
                
                // Fetch state-level data
                const stateResult = await maageClient.query('genome', stateQuery, stateOptions);
                console.log('State result:', stateResult);
                
                // Also fetch county-level data
                const countyQuery = `and(eq(taxon_id,${taxonId}),eq(isolation_country,USA),ne(county,""),facet((field,county),(mincount,1)))`;
                const countyResult = await maageClient.query('genome', countyQuery, stateOptions);
                console.log('County result:', countyResult);
                
                // Get collection year distribution
                const yearQuery = `and(eq(taxon_id,${taxonId}),eq(isolation_country,USA),facet((field,collection_year),(mincount,1)))`;
                const yearResult = await maageClient.query('genome', yearQuery, stateOptions);
                console.log('Year result:', yearResult);
                
                // Get world country-level data
                const countryQuery = `and(eq(taxon_id,${taxonId}),facet((field,isolation_country),(mincount,1)))`;
                const countryResult = await maageClient.query('genome', countryQuery, stateOptions);
                console.log('Country result:', countryResult);
                
                // Get some sample records to show additional metadata and taxonomy info
                const sampleQuery = `and(eq(taxon_id,${taxonId}),eq(isolation_country,USA))&select(genome_id,genome_name,strain,serovar,isolation_source,host_name,collection_year,state_province,genus,species,organism_name)&limit(100)`;
                const sampleResult = await maageClient.query('genome', sampleQuery, { accept: 'application/json' });
                console.log('Sample result:', sampleResult);
                
                // Process the data
                let totalCount = 0;
                
                // Try to get total from the facet response first
                if (stateResult && stateResult.response && typeof stateResult.response.numFound !== 'undefined') {
                    totalCount = stateResult.response.numFound;
                }
                
                // Process taxonomy data
                let taxonInfo = null;
                if (taxonResult) {
                    if (Array.isArray(taxonResult) && taxonResult.length > 0) {
                        taxonInfo = taxonResult[0];
                    } else if (taxonResult.response && taxonResult.response.docs && taxonResult.response.docs.length > 0) {
                        taxonInfo = taxonResult.response.docs[0];
                    } else if (!Array.isArray(taxonResult) && typeof taxonResult === 'object') {
                        taxonInfo = taxonResult;
                    }
                    console.log('Processed taxon info:', taxonInfo);
                }
                
                // If no taxonomy info, try to get it from genome samples
                if (!taxonInfo && sampleResult) {
                    let genomes = null;
                    if (Array.isArray(sampleResult)) {
                        genomes = sampleResult;
                    } else if (sampleResult.response && sampleResult.response.docs) {
                        genomes = sampleResult.response.docs;
                    }
                    
                    if (genomes && genomes.length > 0) {
                        const firstGenome = genomes[0];
                        taxonInfo = {
                            organism_name: firstGenome.organism_name,
                            genus: firstGenome.genus,
                            species: firstGenome.species
                        };
                        console.log('Extracted taxon info from genome sample:', taxonInfo);
                    }
                }
                
                // Process year distribution
                const yearDistribution = processYearFacets(yearResult);
                
                // Process sample metadata
                const sampleMetadata = processSampleMetadata(sampleResult);
                
                const countryDistribution = processCountryFacets(countryResult);
                
                genomeData = {
                    taxonId: taxonId,
                    taxonInfo: taxonInfo,
                    total: totalCount,
                    totalGlobal: countryResult && countryResult.response ? countryResult.response.numFound : 0,
                    states: processStateFacets(stateResult),
                    counties: processCountyFacets(countyResult),
                    countries: countryDistribution,
                    yearDistribution: yearDistribution,
                    metadata: sampleMetadata
                };
                
                // Log country data for debugging
                console.log('Countries from API:', Array.from(countryDistribution.keys()));
                console.log('Total countries with data:', countryDistribution.size);
                
                // Reset query button
                queryBtn.innerHTML = 'Query';
                
                // Update the details panel
                updateDetailsPanel();
                
                // Refresh the current view with new data
                if (currentView === 'world') {
                    renderWorldView();
                } else if (currentView === 'usa') {
                    renderUSAView();
                } else {
                    renderStateView();
                }
                
            } catch (error) {
                console.error('Error querying genome data:', error);
                queryBtn.innerHTML = 'Query';
                alert('Error loading data. Please check the console for details.');
            } finally {
                queryBtn.disabled = false;
            }
        }
        
        // Process state facet results
        function processStateFacets(result) {
            const stateData = new Map();
            
            if (result && result.facet_counts && result.facet_counts.facet_fields && result.facet_counts.facet_fields.state_province) {
                const facets = result.facet_counts.facet_fields.state_province;
                
                // Facets come as [name, count, name, count, ...]
                for (let i = 0; i < facets.length; i += 2) {
                    const stateName = facets[i];
                    const count = facets[i + 1];
                    
                    // Map state names to FIPS codes
                    const fips = getStateFIPSByName(stateName);
                    if (fips) {
                        stateData.set(fips, count);
                    }
                }
            }
            
            return stateData;
        }
        
        // Process county facet results
        function processCountyFacets(result) {
            const countyData = new Map();
            
            if (result && result.facet_counts && result.facet_counts.facet_fields && result.facet_counts.facet_fields.county) {
                const facets = result.facet_counts.facet_fields.county;
                
                // Facets come as [name, count, name, count, ...]
                for (let i = 0; i < facets.length; i += 2) {
                    const countyName = facets[i];
                    const count = facets[i + 1];
                    countyData.set(countyName, count);
                }
            }
            
            return countyData;
        }
        
        // Get state FIPS code by name
        function getStateFIPSByName(name) {
            for (const [fips, stateName] of Object.entries(stateNames)) {
                if (stateName.toLowerCase() === name.toLowerCase()) {
                    return fips;
                }
            }
            return null;
        }
        
        // Normalize country names for matching
        function normalizeCountryName(name) {
            if (!name) return '';
            
            // Common country name mappings
            const countryMappings = {
                'usa': 'united states',
                'united states of america': 'united states',
                'u.s.a.': 'united states',
                'u.s.': 'united states',
                'us': 'united states',
                'uk': 'united kingdom',
                'u.k.': 'united kingdom',
                'great britain': 'united kingdom',
                'england': 'united kingdom',
                'holland': 'netherlands',
                'the netherlands': 'netherlands',
                'czech republic': 'czechia',
                'russia': 'russian federation',
                'south korea': 'korea, south',
                'north korea': 'korea, north',
                'vietnam': 'viet nam',
                'brunei': 'brunei darussalam',
                'cape verde': 'cabo verde',
                'east timor': 'timor-leste',
                'ivory coast': "côte d'ivoire",
                'macedonia': 'north macedonia',
                'burma': 'myanmar',
                'swaziland': 'eswatini'
            };
            
            // Normalize the name
            let normalized = name.toLowerCase().trim();
            
            // Remove common prefixes
            normalized = normalized.replace(/^the\s+/, '');
            
            // Check if we have a mapping
            if (countryMappings[normalized]) {
                return countryMappings[normalized];
            }
            
            return normalized;
        }
        
        // Process country facet results
        function processCountryFacets(result) {
            const countryData = new Map();
            
            if (result && result.facet_counts && result.facet_counts.facet_fields && result.facet_counts.facet_fields.isolation_country) {
                const facets = result.facet_counts.facet_fields.isolation_country;
                
                // Facets come as [name, count, name, count, ...]
                for (let i = 0; i < facets.length; i += 2) {
                    const countryName = facets[i];
                    const count = facets[i + 1];
                    countryData.set(countryName, count);
                }
            }
            
            return countryData;
        }
        
        // Process year facet results
        function processYearFacets(result) {
            const yearData = new Map();
            
            if (result && result.facet_counts && result.facet_counts.facet_fields && result.facet_counts.facet_fields.collection_year) {
                const facets = result.facet_counts.facet_fields.collection_year;
                
                for (let i = 0; i < facets.length; i += 2) {
                    const year = facets[i];
                    const count = facets[i + 1];
                    yearData.set(year, count);
                }
            }
            
            return yearData;
        }
        
        // Process sample metadata
        function processSampleMetadata(result) {
            const metadata = {
                strains: new Set(),
                serovars: new Set(),
                isolationSources: new Set(),
                hostNames: new Set()
            };
            
            if (result && Array.isArray(result)) {
                result.forEach(genome => {
                    if (genome.strain) metadata.strains.add(genome.strain);
                    if (genome.serovar) metadata.serovars.add(genome.serovar);
                    if (genome.isolation_source) metadata.isolationSources.add(genome.isolation_source);
                    if (genome.host_name) metadata.hostNames.add(genome.host_name);
                });
            }
            
            return metadata;
        }
        
        // Update the details panel with query results
        function updateDetailsPanel() {
            if (!genomeData) return;
            
            // Show the details panel
            document.getElementById('details-panel').classList.remove('hidden');
            
            // Update taxon name header
            const taxonNameHeader = document.getElementById('taxon-name-header');
            if (genomeData.taxonInfo) {
                const info = genomeData.taxonInfo;
                console.log('Taxon info in updateDetailsPanel:', info);
                
                // Try different field names that might contain the organism name
                let scientificName = null;
                if (info.scientific_name) {
                    scientificName = info.scientific_name;
                } else if (info.organism_name) {
                    scientificName = info.organism_name;
                } else if (info.taxon_name) {
                    scientificName = info.taxon_name;
                } else if (info.genus && info.species) {
                    scientificName = `${info.genus} ${info.species}`;
                } else if (info.genus) {
                    scientificName = `${info.genus} sp.`;
                }
                
                taxonNameHeader.textContent = scientificName || `Taxon ID: ${genomeData.taxonId}`;
            } else {
                taxonNameHeader.textContent = `Taxon ID: ${genomeData.taxonId}`;
            }
            
            // Update summary statistics based on current view
            if (currentView === 'world') {
                document.getElementById('total-genomes').textContent = genomeData.totalGlobal.toLocaleString();
                document.getElementById('total-genomes-label').textContent = 'Total Worldwide Genomes';
                
                const countriesWithData = Array.from(genomeData.countries.values()).filter(count => count > 0).length;
                document.getElementById('states-with-data').textContent = countriesWithData;
                document.getElementById('states-with-data').nextElementSibling.textContent = 'Countries with Data';
                
                const avgPerCountry = countriesWithData > 0 ? Math.round(genomeData.totalGlobal / countriesWithData) : 0;
                document.getElementById('avg-per-state').textContent = avgPerCountry.toLocaleString();
                document.getElementById('avg-per-state').nextElementSibling.textContent = 'Average per Country';
            } else {
                document.getElementById('total-genomes').textContent = genomeData.total.toLocaleString();
                document.getElementById('total-genomes-label').textContent = 'Total USA Genomes';
                
                const statesWithData = Array.from(genomeData.states.values()).filter(count => count > 0).length;
                document.getElementById('states-with-data').textContent = statesWithData;
                document.getElementById('states-with-data').nextElementSibling.textContent = 'States with Data';
                
                const avgPerState = statesWithData > 0 ? Math.round(genomeData.total / statesWithData) : 0;
                document.getElementById('avg-per-state').textContent = avgPerState.toLocaleString();
                document.getElementById('avg-per-state').nextElementSibling.textContent = 'Average per State';
            }
            
            // Update top states/countries
            const topStatesEl = document.getElementById('top-states');
            const topRegionsTitle = document.getElementById('top-regions-title');
            
            if (currentView === 'world') {
                topRegionsTitle.textContent = 'Top 10 Countries by Genome Count';
                const sortedCountries = Array.from(genomeData.countries.entries())
                    .filter(([name, count]) => count > 0)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 10);
                
                topStatesEl.innerHTML = sortedCountries.map(([countryName, count]) => {
                    const percentage = ((count / genomeData.totalGlobal) * 100).toFixed(1);
                    return `
                        <div class="flex items-center justify-between p-2 bg-gray-50 rounded">
                            <span class="font-medium">${countryName}</span>
                            <span class="text-sm text-gray-600">${count.toLocaleString()} (${percentage}%)</span>
                        </div>
                    `;
                }).join('');
            } else {
                topRegionsTitle.textContent = 'Top 5 States by Genome Count';
                const sortedStates = Array.from(genomeData.states.entries())
                    .filter(([fips, count]) => count > 0)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 5);
                
                topStatesEl.innerHTML = sortedStates.map(([fips, count]) => {
                    const stateName = stateNames[fips] || 'Unknown';
                    const percentage = ((count / genomeData.total) * 100).toFixed(1);
                    return `
                        <div class="flex items-center justify-between p-2 bg-gray-50 rounded">
                            <span class="font-medium">${stateName}</span>
                            <span class="text-sm text-gray-600">${count.toLocaleString()} (${percentage}%)</span>
                        </div>
                    `;
                }).join('');
            }
            
            // Update year distribution
            const yearDistEl = document.getElementById('year-distribution');
            if (genomeData.yearDistribution.size > 0) {
                const sortedYears = Array.from(genomeData.yearDistribution.entries())
                    .sort((a, b) => b[0] - a[0])  // Sort by year descending
                    .slice(0, 10);  // Show last 10 years
                
                yearDistEl.innerHTML = `
                    <div class="space-y-1">
                        ${sortedYears.map(([year, count]) => `
                            <div class="flex items-center gap-2">
                                <span class="text-xs font-mono">${year}:</span>
                                <div class="flex-1 bg-gray-200 rounded-full h-2">
                                    <div class="bg-maage-primary-500 h-2 rounded-full" style="width: ${(count / genomeData.total * 100).toFixed(1)}%"></div>
                                </div>
                                <span class="text-xs text-gray-600">${count.toLocaleString()}</span>
                            </div>
                        `).join('')}
                    </div>
                `;
            } else {
                yearDistEl.innerHTML = '<div class="text-gray-500">No year data available</div>';
            }
            
            // Update metadata section with additional info
            if (genomeData.metadata) {
                const metadataSection = document.getElementById('metadata-section');
                metadataSection.innerHTML += `
                    <div class="mt-4 grid grid-cols-2 gap-4 text-sm">
                        ${genomeData.metadata.serovars.size > 0 ? `
                            <div>
                                <h5 class="font-semibold text-gray-700 mb-1">Serovars (${genomeData.metadata.serovars.size})</h5>
                                <div class="text-xs text-gray-600">${Array.from(genomeData.metadata.serovars).slice(0, 5).join(', ')}${genomeData.metadata.serovars.size > 5 ? '...' : ''}</div>
                            </div>
                        ` : ''}
                        ${genomeData.metadata.hostNames.size > 0 ? `
                            <div>
                                <h5 class="font-semibold text-gray-700 mb-1">Host Species (${genomeData.metadata.hostNames.size})</h5>
                                <div class="text-xs text-gray-600">${Array.from(genomeData.metadata.hostNames).slice(0, 5).join(', ')}${genomeData.metadata.hostNames.size > 5 ? '...' : ''}</div>
                            </div>
                        ` : ''}
                    </div>
                `;
            }
        }
        
        // Get genome data for visualization
        function getVisualizationData(features, viewType = 'state') {
            if (!genomeData) {
                return generateMockData(features);
            }
            
            const data = new Map();
            
            if (viewType === 'state') {
                // For state view, use state-level counts
                features.forEach(feature => {
                    const fips = feature.id;
                    const count = genomeData.states.get(fips) || 0;
                    const maxCount = Math.max(...genomeData.states.values(), 1);
                    
                    data.set(fips, {
                        value: count === 0 ? 0 : Math.max((count / maxCount) * 100, 5), // Ensure minimum visibility for non-zero
                        samples: count,
                        hasData: count > 0
                    });
                });
            } else if (viewType === 'county') {
                // For county view, use county-level counts
                features.forEach(feature => {
                    const countyName = feature.properties.NAME;
                    const geoid = feature.properties.GEOID;
                    const count = genomeData.counties.get(countyName) || 0;
                    const maxCount = Math.max(...genomeData.counties.values(), 1);
                    
                    data.set(geoid, {
                        value: count === 0 ? 0 : Math.max((count / maxCount) * 100, 5), // Ensure minimum visibility for non-zero
                        samples: count,
                        hasData: count > 0
                    });
                });
            } else if (viewType === 'country') {
                // For world view, use country-level counts
                features.forEach(feature => {
                    // Try different property names for country name
                    const mapCountryName = feature.properties.NAME || 
                                         feature.properties.name || 
                                         feature.properties.NAME_EN ||
                                         feature.properties.ADMIN ||
                                         feature.properties.admin ||
                                         'Unknown';
                    
                    // Try to find a match in the genome data
                    let count = 0;
                    let matchedName = null;
                    
                    // First try exact match
                    if (genomeData.countries.has(mapCountryName)) {
                        count = genomeData.countries.get(mapCountryName);
                        matchedName = mapCountryName;
                    } else {
                        // Try to find a match with different variations
                        for (const [apiCountryName, apiCount] of genomeData.countries.entries()) {
                            // Try exact match ignoring case
                            if (apiCountryName.toLowerCase() === mapCountryName.toLowerCase()) {
                                count = apiCount;
                                matchedName = apiCountryName;
                                break;
                            }
                            // Try common country name variations
                            if (normalizeCountryName(apiCountryName) === normalizeCountryName(mapCountryName)) {
                                count = apiCount;
                                matchedName = apiCountryName;
                                break;
                            }
                        }
                    }
                    
                    const maxCount = Math.max(...genomeData.countries.values(), 1);
                    
                    data.set(feature.id, {
                        value: count === 0 ? 0 : Math.max((count / maxCount) * 100, 5),
                        samples: count,
                        hasData: count > 0,
                        name: matchedName || mapCountryName,
                        apiName: matchedName
                    });
                    
                    // Debug logging for country matching
                    if (count > 0) {
                        console.log(`Matched: ${mapCountryName} -> ${matchedName} (${count} genomes)`);
                    }
                });
            }
            
            return data;
        }

        // Render USA view
        function renderUSAView() {
            if (!usaData) return;
            
            const container = document.getElementById('map');
            container.innerHTML = '';
            
            const width = container.clientWidth;
            const height = container.clientHeight;
            
            const svg = d3.select(container)
                .append('svg')
                .attr('viewBox', [0, 0, width, height])
                .attr('class', 'w-full h-auto');
            
            // Create path generator without projection
            const path = d3.geoPath();
            
            const visualizationData = getVisualizationData(usaData.features, 'state');
            
            const tooltip = d3.select('.tooltip');
            
            svg.selectAll('path')
                .data(usaData.features)
                .enter()
                .append('path')
                .attr('class', 'state')
                .attr('d', path)
                .attr('fill', d => {
                    const data = visualizationData.get(d.id);
                    if (!data || data.samples === 0) {
                        return '#f9fafb'; // Very light gray for no data
                    }
                    return colorScale(data.value);
                })
                .on('mouseover', function(event, d) {
                    const data = visualizationData.get(d.id);
                    const stateName = stateNames[d.id] || 'Unknown';
                    
                    tooltip.style('opacity', 1)
                        .html(`
                            <div class="font-semibold text-maage-primary-900">${stateName}</div>
                            <div class="text-xs text-gray-600 mt-1">
                                <div>Genomes: ${data ? data.samples.toLocaleString() : '0'}</div>
                                ${genomeData ? `<div class="text-xs text-gray-500 mt-1">Taxon ID: ${genomeData.taxonId}</div>` : ''}
                            </div>
                        `)
                        .style('left', (event.pageX + 10) + 'px')
                        .style('top', (event.pageY - 28) + 'px');
                })
                .on('mouseout', function() {
                    tooltip.style('opacity', 0);
                })
                .on('click', function(event, d) {
                    selectedState = d.id;
                    document.getElementById('state-dropdown').value = d.id;
                    setActiveView('state');
                });
        }

        // Render world view
        function renderWorldView() {
            if (!worldData) return;
            
            const container = document.getElementById('map');
            container.innerHTML = '';
            
            const width = container.clientWidth;
            const height = container.clientHeight;
            
            const svg = d3.select(container)
                .append('svg')
                .attr('viewBox', [0, 0, width, height])
                .attr('class', 'w-full h-auto');
            
            // Create projection for world map
            const projection = d3.geoNaturalEarth1()
                .fitSize([width * 0.95, height * 0.85], worldData);
            
            const path = d3.geoPath().projection(projection);
            
            const visualizationData = getVisualizationData(worldData.features, 'country');
            
            const tooltip = d3.select('.tooltip');
            
            // Create main group for centering
            const worldGroup = svg.append('g')
                .attr('transform', `translate(${width * 0.025}, ${height * 0.075})`);
            
            worldGroup.selectAll('path')
                .data(worldData.features)
                .enter()
                .append('path')
                .attr('class', 'country')
                .attr('d', path)
                .attr('fill', d => {
                    const data = visualizationData.get(d.id);
                    if (!data || data.samples === 0) {
                        return '#f9fafb'; // Very light gray for no data
                    }
                    return colorScale(data.value);
                })
                .on('mouseover', function(event, d) {
                    const data = visualizationData.get(d.id);
                    const mapName = d.properties.name || d.properties.NAME || 'Unknown';
                    const displayName = data?.apiName || mapName;
                    
                    tooltip.style('opacity', 1)
                        .html(`
                            <div class="font-semibold text-maage-primary-900">${displayName}</div>
                            ${data?.apiName && data.apiName !== mapName ? `<div class="text-xs text-gray-500">(${mapName})</div>` : ''}
                            <div class="text-xs text-gray-600 mt-1">
                                <div>Genomes: ${data ? data.samples.toLocaleString() : '0'}</div>
                                ${genomeData ? `<div class="text-xs text-gray-500 mt-1">Taxon ID: ${genomeData.taxonId}</div>` : ''}
                            </div>
                        `)
                        .style('left', (event.pageX + 10) + 'px')
                        .style('top', (event.pageY - 28) + 'px');
                })
                .on('mouseout', function() {
                    tooltip.style('opacity', 0);
                });
            
            // Add title
            svg.append('text')
                .attr('x', width / 2)
                .attr('y', 30)
                .attr('text-anchor', 'middle')
                .attr('class', 'text-xl font-semibold fill-maage-primary-900')
                .text('World Distribution');
            
            // Add total count info
            if (genomeData && genomeData.totalGlobal > 0) {
                svg.append('text')
                    .attr('x', width / 2)
                    .attr('y', height - 20)
                    .attr('text-anchor', 'middle')
                    .attr('class', 'text-sm text-gray-600')
                    .text(`${genomeData.totalGlobal.toLocaleString()} total genomes worldwide`);
            }
        }

        // Render state view
        async function renderStateView() {
            await loadGeoJsonCountiesData();
            if (!geoJsonCountiesData) return;
            
            const container = document.getElementById('map');
            container.innerHTML = '';
            
            const width = container.clientWidth;
            const height = container.clientHeight;
            
            const svg = d3.select(container)
                .append('svg')
                .attr('viewBox', [0, 0, width, height])
                .attr('class', 'w-full h-auto');
            
            // Filter counties for selected state
            const stateCounties = {
                type: 'FeatureCollection',
                features: geoJsonCountiesData.features.filter(d => d.properties.STATEFP === selectedState)
            };
            
            if (stateCounties.features.length === 0) {
                container.innerHTML = '<div class="flex items-center justify-center h-full text-gray-500">No county data available for this state</div>';
                return;
            }
            
            // Create projection - use Mercator for individual states to avoid distortion
            const projection = d3.geoMercator()
                .fitSize([width * 0.9, height * 0.8], stateCounties);
            
            const path = d3.geoPath().projection(projection);
            
            // Get visualization data for counties
            const visualizationData = getVisualizationData(stateCounties.features, 'county');
            
            const tooltip = d3.select('.tooltip');
            
            // Create main group for state
            const stateGroup = svg.append('g')
                .attr('transform', `translate(${width * 0.05}, ${height * 0.1})`);
            
            // Draw counties
            stateGroup.selectAll('path')
                .data(stateCounties.features)
                .enter()
                .append('path')
                .attr('class', 'county')
                .attr('d', path)
                .attr('fill', d => {
                    const data = visualizationData.get(d.properties.GEOID);
                    if (!data || data.samples === 0) {
                        return '#f9fafb'; // Very light gray for no data
                    }
                    return colorScale(data.value);
                })
                .on('mouseover', function(event, d) {
                    const data = visualizationData.get(d.properties.GEOID);
                    const countyName = d.properties.NAME || 'Unknown County';
                    
                    tooltip.style('opacity', 1)
                        .html(`
                            <div class="font-semibold text-maage-primary-900">${countyName}</div>
                            <div class="text-xs text-gray-500">${stateNames[selectedState]}</div>
                            <div class="text-xs text-gray-600 mt-1">
                                <div>Genomes: ${data ? data.samples.toLocaleString() : '0'}</div>
                                ${genomeData ? `<div class="text-xs text-gray-500 mt-1">Taxon ID: ${genomeData.taxonId}</div>` : ''}
                            </div>
                        `)
                        .style('left', (event.pageX + 10) + 'px')
                        .style('top', (event.pageY - 28) + 'px');
                })
                .on('mouseout', function() {
                    tooltip.style('opacity', 0);
                });
            
            // Add state name
            svg.append('text')
                .attr('x', width / 2)
                .attr('y', 30)
                .attr('text-anchor', 'middle')
                .attr('class', 'text-xl font-semibold fill-maage-primary-900')
                .text(stateNames[selectedState]);
            
            // Add county count info
            svg.append('text')
                .attr('x', width / 2)
                .attr('y', height - 20)
                .attr('text-anchor', 'middle')
                .attr('class', 'text-sm text-gray-600')
                .text(`${stateCounties.features.length} counties`);
        }
    </script>
</body>
</html>